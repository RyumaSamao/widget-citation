<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Donut Notion Safe</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#1B1B1B;
  --panel:#292929;
  --text:#eaeaea;
  --muted:rgba(255,255,255,0.08);
}

html, body{
  margin:0; padding:0;
  width:100%; height:100%;
  background:var(--bg);
  font-family:Inter, sans-serif;
  overflow:visible;
}

body{
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:1em;
  box-sizing:border-box;
}

.card{
  display:flex;
  flex-direction:column;
  align-items:center;
  background:var(--panel);
  border-radius:1em;
  padding:1em;
  gap:1em;
  width:100%;
  max-width:100%;
  height:auto;
  box-sizing:border-box;
  overflow:visible;
}

.chart-area{
  position: relative;
  width:100%;
  height:auto;
  overflow:visible;
}

.donut-shell{
  width:100%;
  height:100%;
  position:relative;
  transition: transform 0.5s ease-in-out;
  overflow:visible;
}

canvas{
  width:100% !important;
  height:auto !important;
  display:block;
}

.center-number{
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%, -50%);
  color:var(--text);
  font-size:1.2em;
  font-weight:700;
  pointer-events:none;
}

.legend{
  display:flex;
  flex-direction:column;
  gap:0.4em;
  justify-content:center;
  width:100%;
  overflow:visible;
}

.item{
  display:flex;
  align-items:center;
  gap:0.4em;
  background:var(--muted);
  padding:0.3em 0.6em;
  border-radius:0.5em;
  color:var(--text);
  font-size:0.75em;
  justify-content:space-between;
}

.badge{ width:0.7em; height:0.7em; border-radius:50%; flex-shrink:0; }

button#updateBtn{
  margin-top: 1em;
  padding:0.5em 1em;
  border:none;
  border-radius:0.5em;
  background:#2FC7FF;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="card">
  <div class="chart-area">
    <div class="donut-shell" id="donutShell">
      <canvas id="donutCanvas"></canvas>
      <div class="center-number" id="centerNumber">0</div>
    </div>
  </div>
  <div class="legend" id="legendArea"></div>
  <button id="updateBtn">Mettre à jour</button>
</div>

<script>
const DEFAULT={
  labels:["Anime","Films","Series"],
  values:[0,0,0],
  colors:["#F5B333","#F06292","#8C8CFF"]
};

function lightenColor(color, percent){
  const f=color.slice(1),
        R=parseInt(f.slice(0,2),16),
        G=parseInt(f.slice(2,4),16),
        B=parseInt(f.slice(4,6),16);
  return "#" + (0x1000000 + (Math.round(R+(255-R)*percent)<<16) + (Math.round(G+(255-G)*percent)<<8) + Math.round(B+(255-B)*percent)).toString(16).slice(1);
}

const hoverColors=DEFAULT.colors.map(c=>lightenColor(c,0.3));
const ctx=document.getElementById("donutCanvas").getContext("2d");

let chart=new Chart(ctx,{
  type:"doughnut",
  data:{
    labels:DEFAULT.labels,
    datasets:[{
      data:DEFAULT.values,
      backgroundColor:DEFAULT.colors,
      hoverBackgroundColor:hoverColors,
      hoverOffset:12,
      spacing:4,
      borderColor:"#292929",
      borderWidth:2,
      borderRadius:8
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:true,
    cutout:"60%",
    plugins:{ legend:{display:false}, tooltip:{enabled:true} },
    onHover:(evt,els)=>{document.getElementById("donutShell").style.transform=els.length?"scale(1.05)":"scale(1)"}
  }
});

function buildLegend(){
  const leg=document.getElementById("legendArea");
  leg.innerHTML="";
  const order=[0,1,2];
  order.forEach(i=>{
    const item=document.createElement("div");
    item.className="item";
    item.innerHTML=`
      <div style="display:flex;align-items:center;gap:0.3em;">
        <div class="badge" style="background:${DEFAULT.colors[i]}"></div>
        <div>${DEFAULT.labels[i]}</div>
      </div>
      <div>${DEFAULT.values[i]}</div>
    `;
    leg.appendChild(item);
  });
}
buildLegend();
document.getElementById("centerNumber").textContent=DEFAULT.values.reduce((a,b)=>a+b,0);

// --- FETCH counts.json depuis GitHub / Vercel avec token ---
async function updateDataFromCounts(){
  try{
    const token = "TON_TOKEN_ICI"; // <-- ici tu mets ton token
    const res = await fetch("https://raw.githubusercontent.com/RyumaSamao/notion-stats/main/counts.json", {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });
    const data = await res.json();

    DEFAULT.labels=["Anime","Films","Series"];
    DEFAULT.values=[data.anime, data.films, data.series];
    DEFAULT.colors=["#F5B333","#F06292","#8C8CFF"];

    chart.data.labels=DEFAULT.labels;
    chart.data.datasets[0].data=DEFAULT.values;
    chart.data.datasets[0].backgroundColor=DEFAULT.colors;
    chart.update();

    buildLegend();
    document.getElementById("centerNumber").textContent=DEFAULT.values.reduce((a,b)=>a+b,0);
  }catch(err){
    console.error("Impossible de récupérer counts.json :", err);
  }
}

// --- Bouton pour mettre à jour le graphique ---
document.getElementById("updateBtn").addEventListener("click", updateDataFromCounts);
</script>
</body>
</html>
