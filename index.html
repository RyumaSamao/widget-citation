<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Player Citations One Piece — Recherche & Quiz</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet" />
<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  height: 100%;
}
body {
  background: #191919;
  color: white;
  font-family: 'Bangers', cursive;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.main-wrap {
  width: 100%;
  max-width: 1000px;
  padding: 0 20px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* --- zone recherche + scan + quiz --- */
.top-controls {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 2rem;
}

.search-bar {
  flex: 1;
  display: flex;
  justify-content: center;
  position: relative;
}

.search-bar input {
  width: 100%;
  max-width: 560px;
  padding: 8px 12px;
  font-size: 20px;
  border-radius: 10px;
  border: none;
  outline: none;
}

.search-bar .reset-search {
  position: absolute;
  right: -10px; /* PC par défaut */
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
  cursor: pointer;
  border: none;
  background: transparent;
  color: white;
  transition: color 0.3s;
}
.search-bar .reset-search:hover { color: #ff6666; }

.scan-number {
  font-size: 20px;
  opacity: 1;
  transition: opacity 0.9s ease-in-out;
  min-width: 80px;
  text-align: left;
}

#counter {
  font-size: 20px;
  min-width: 60px;
  text-align: center;
}

.quiz-btn {
  font-size: 20px;
  padding: 6px 12px;
  background: transparent;
  color: white;
  border: 2px solid white;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.25s, color 0.25s, opacity 0.9s ease-in-out;
  opacity: 1;
}
.quiz-btn.active {
  background: white;
  color: #191919;
}

/* zone citation */
.quote-container {
  width: 100%;
  max-width: 1000px;
  text-align: center;
  margin-bottom: 1.5rem;
  padding: 0 20px;
}

.quote-text, .quote-author {
  font-size: clamp(18px, 2.3vw, 26px);
  line-height: 1.6;
  letter-spacing: 1px;
  user-select: none;
  transition: opacity 0.9s ease-in-out;
  white-space: pre-line;
  word-wrap: break-word;
  opacity: 1;
}

.quote-text.long-quote {
  font-size: clamp(14px, 2vw, 18px);
}

.hiluluk {
  white-space: normal !important;
}

.fade-out {
  opacity: 0 !important;
}

/* contrôles bas */
.controls {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: nowrap;
  margin-top: 8px;
}

button.control-btn {
  background: transparent;
  border: 2px solid white;
  color: white;
  font-family: 'Bangers', cursive;
  font-size: 18px;
  cursor: pointer;
  padding: 10px 36px;
  border-radius: 6px;
  user-select: none;
  transition: background 0.3s, color 0.3s;
  display: flex;
  justify-content: center;
  align-items: center;
}
button.control-btn:hover {
  background: white;
  color: #191919;
}

.btn-audio {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid white;
  background: transparent;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.3s, transform 0.2s;
}
.btn-audio:hover { background: white; }
.btn-audio svg { fill: white; width: 28px; height: 28px; transition: fill 0.3s; }
.btn-audio:hover svg { fill: #191919; }

/* PC */
@media (min-width: 769px) {
  .search-bar .reset-search { right: -10px; display: block; }
}

/* MOBILE */
@media (max-width: 768px) {
  .main-wrap { padding: 0 12px; }
  .search-bar input { font-size: 16px; }
  .scan-number, .quiz-btn { font-size: 16px; }
  .quote-text, .quote-author { font-size: clamp(16px, 3.5vw, 22px); }
  .top-controls { justify-content: flex-start; flex-wrap: wrap; }
  #counter { order: 2; margin-left: auto; }
  .search-bar .reset-search { display: none; } /* croix disparait sur mobile */
}
</style>
</head>
<body>
<div class="main-wrap">

  <!-- TOP CONTROLS -->
  <div class="top-controls">
    <div id="scanNumber" class="scan-number"></div>

    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Rechercher une citation / auteur / scan..." />
      <button class="reset-search">✖</button>
    </div>

    <div id="counter">0/0</div>

    <button id="quizBtn" class="quiz-btn">Quiz</button>
  </div>

  <!-- CITATION -->
  <div class="quote-container">
    <div id="quote" class="quote-text"></div>
    <div id="author" class="quote-author"></div>
  </div>

  <!-- BAS : navigation + audio -->
  <div class="controls">
    <button id="prevBtn" class="control-btn" aria-label="Citation précédente">⏮</button>
    <button id="playPauseBtn" class="control-btn" aria-label="Pause la rotation">❚❚</button>
    <button id="nextBtn" class="control-btn" aria-label="Citation suivante">⏭</button>
    <button id="audioBtn" class="btn-audio" aria-label="Jouer/arrêter audio" title="Jouer/arrêter audio">
      <svg viewBox="0 0 24 24" id="audioIcon">
        <polygon points="3,9 7,9 12,4 12,20 7,15 3,15"></polygon>
        <rect x="14" y="8" width="2" height="8"></rect>
        <rect x="18" y="7" width="2" height="10"></rect>
      </svg>
    </button>
  </div>
</div>

<script>
const quotes = [
  {text: "Blesser les autres ! T'as raison, vivre c'est risquer de blesser les autres !\nTa mort blessera... tous ceux qui t'aiment ! Écoute bien, Kuma.\nTu es un héros... Pour Bonney ! Pour tout le monde !", author: "Vegapunk", audio: "audios-citations/Kumahero.mp3", scan: "Épisode 1136"},
  {text: "Kaizoku-Ō ni naru otoko da !!!", author: "Monkey D. Luffy", audio: "audios-citations/LuffyTokoda.mp3", scan: "Épisode 1015"},
  {text: "STOOOOP !!! Je ne veux pas savoir où est le trésor !\nJe ne veux même pas savoir s'il existe ou pas !!\nsi tu demandes au vieux tout ce qu'il y a à savoir, alors j'arrête d'être pirate !!!\nJe n'ai pas envie de vivre... une aventure aussi chiante !!! ", author: "Monkey D. Luffy", audio: "audios-citations/LuffySTOP.mp3", scan: "Épisode 400"},
  {text: "J'ai pas l'intention de conquérir quoi que ce soit ! Je pense juste que la personne la plus libre dans tout cet océan, est le seigneur des pirates !!.", author: "Monkey D. Luffy", audio: "audios-citations/LuffyConquérir.mp3", scan: "Épisode 400"},
  {text: "Laisse-nous nous occuper de tout, FrèreHoshi ! ... On est amis, non ?", author: "Monkey D. Luffy", audio: "audios-citations/LuffyHoshiAmi.mp3", scan: "Épisode 564"},
  {text: "Hody , c'est ça ? Je vais te dégommer.\nTu peux devenir le roi de ce que tu veux, où tu veux,\nmais il n'y a la place... que pour un seul Roi des pirates !! ", author: "Monkey D. Luffy", audio: "audios-citations/LuffyPlace.mp3", scan: "Épisode 554"},
  {text: "Parce que j’ai personne d’autre sur qui compter !! je peux pas rentrer au village de fuschia\net je déteste les brigands… Si je t’avais pas suivi, je serai tout seul…\net être tout seul ça fait plus mal que des blessures !!", author: "Monkey D. Luffy", audio: "audios-citations/LuffySeul.mp3", scan: "Épisode 495"},
  {text: "Je ne peux pas quitter cette île ! Je ne peux pas battre mon père ! Je ne peux pas aller sauver... mon seul ami ! Je ne suis... pas libre...", author: "Yamato", audio: "audios-citations/YamatoLibre.mp3", scan: "Épisode 1015"},
  {text: "Beck, tu ne crois pas qu'il est temps d'aller le récupérer ?... Le One Piece", author: "Shanks", audio: "audios-citations/ShanksOP.mp3", scan: "Épisode 1081"},
  {text: "Je deviendrai... le roi des enfers !", author: "Roronoa Zoro", audio: "audios-citations/RoiEnfer.mp3", scan: "Épisode 1062"},
  {text: "Jusqu'au Jour où je le vaincrai pour devenir le meilleur sabreur...\nje ne perdrai pas le moindre combat !! Un problème avec ça, roi des pirates ?!!", author: "Roronoa Zoro", audio: "audios-citations/PromesseZoro.mp3", scan: "Épisode 1062"},
  {text: "Peux tu porter sur ton dos... le pays de wa...\nJe t'en sup...\nAbruti ! Bien sûr que oui ! c'est le pays de mes amis !! ", author: "Kinemon / Monkey D. Luffy", audio: "audios-citations/Paysamis.mp3", scan: "Épisode 1015"},
  {text: "Momo !!! Je crois en toi !", author: "Monkey D. Luffy", audio: "audios-citations/MomoCroire.mp3", scan: "Épisode 1074"},
  {text: "ça y est, j'ai atteint mon apogée ! C'est ça !\nGear fifth !!!", author: "Monkey D. Luffy", audio: "audios-citations/GearFifth.mp3", scan: "Épisode 1071"},
  {text: "Je vois... Dans ce cas... Je serai .....!!!", author: "Monkey D. Luffy", audio: "audios-citations/Reve.mp3", scan: "Épisode 1015"},
  {text: "C'est quoi tout ce sang ?! T'es encore en vie ?! Il est où ce type ?! Il c'est passé quoi ici ?!! Rien... Il ne s'est... rien passé du tout... ", author: "Roronoa Zoro", audio: "audios-citations/Riendutout.mp3", scan: "Épisode 377"},
  {text: "Momonosuke... Momosuke ! Je l'entends ! JOYBOY... est de retour !!!", author: "Zunesha", audio: "audios-citations/JOYBOY.mp3", scan: "Épisode 1070"},
  {text: "Ace... Ace... Où est AAAAce ??!!!!!", author: "Monkey D. Luffy", audio: "audios-citations/LuffyRage.mp3", scan: "Épisode 491"},
  {text: "Mes nakamas. Il me reste mes nakamas ! Zoro ! Nami ! Usopp ! Sanji ! Chopper ! Robin ! Franky ! Brook ! J'ai des compagnons !! Je veux les revoir vite. Je veux les revoir !!!", author: "Monkey D. Luffy", audio: "audios-citations/LuffyNakamas.mp3", scan: "Épisode 505"},
  {text: "Vous n'avez tracé aucun appel. Vous n'avez absolument rien entendu. Le Royaume de Lulusia ? Il n'y a... Aucun pays de ce nom-là", author: "Shepherd Ju Peter", audio: "audios-citations/Lulusia.mp3", scan: "Épisode 1089"},
  {text: "C'est amusant, Papa ! Moi aussi, je veux voir Nika ! Don-do-to-to Don-do-to-to !\nIl viendra en souriant et en dansant sur ce rythme !", author: "Bonney / Kuma", audio: "audios-citations/dondototo.mp3", scan: "Épisode 1140"},
  {text: "Heu... Allo ? Un-deux un-deux . Le monde ! Le monde entier doit m'écouter !", author: "Vegapunk", audio: "audios-citations/Vegasekai.mp3", scan: "Épisode 1142"},
  {text: "Je suis le Dr. Vegapunk. Humble génie scientifique.\nLe message que je m'apprête à transmettre risque de vous choquer,\nmais il s'agit là... de la verité cachée de notre monde !", author: "Vegapunk", audio: "audios-citations/Vegamessage.mp3", scan: "Épisode 1142"},
  {text: "Merci... d'avoir sauvé Bonney. Peux-tu lui transmettre un message quand tu la verras ?\nSouhaite-lui un joyeux... dixième anniversaire", author: "Bartholomew Kuma", audio: "audios-citations/KumaMerci.mp3", scan: "Épisode 1136"},
  {text: "Nous sommes là pour toi, Mugiwara !\nDieu du Soleil !", author: "Dorry / Broggy", audio: "audios-citations/GeantsNika.mp3", scan: "Épisode 1141"},
  {text: "Kizaru ! Nous sommes 100 fois plus forts qu'avant !!", author: "Monkey D. Luffy", audio: "audios-citations/Kizaru100x.mp3", scan: "Épisode 1125"},
  {text: "Mettez les voiles !!!!", author: "Monkey D. Luffy", audio: "audios-citations/LuffyVoile.mp3", scan: "Épisode 522"},
  {text: "La passion et les rêves sont comme le temps, rien ne peut les arrêter...", author: "Gol D. Roger", audio: "audios-citations/dragonroger.mp3", scan: "Épisode 53"},
  {text: "Un pirate doit être fier de son nom. Tâchez de vous souvenir du mien", author: "Monkey D. Luffy", audio: "audios-citations/luffynom.mp3", scan: "Épisode 17"},
  {text: "Vivre n'est pas un crime", author: "Franky", audio: "audios-citations/Frankyvivre.m4a", scan: "Épisode 263"},
  {text: "SUUUUUUUUUUPEEEEEER", author: "Franky", audio: "audios-citations/Supeeer.mp3", scan: "Épisode 528"},
  {text: "Mon trésor ? Je vous le laisse si vous voulez ! Trouvez-le !\nJe l'ai laissé quelque part en ce monde !", author: "Gol D. Roger", audio: "audios-citations/Rogertresor.mp3", scan: "Épisode 1"},
  {text: "L'aire où les pirates pouvaient rêver est révolue selon eux ?! Ben Voyons ! Les Hommes ne cesseront jamais d'avoir des rêves !!", author: "Marshall D. Teach", audio: "audios-citations/teachdreams.mp3", scan: "Épisode 147"},
  {text: "Ça fait un bail, hein chapeau de paille ?", author: "Crocodile", audio: "audios-citations/CrocodileHisha.mp3", scan: "Épisode 442"},
  {text: "Ne vous souciez ni du regard, ni de ce que disent les autres ! Et soyez assez fortes pour pouvoir rire au nez de ceux qui vous critiquent", author: "Belmer", audio: "audios-citations/belmersacrifice.mp3", scan: "Épisode 36"},
  {text: "Ne pas voir la pourriture de ce monde est un plaisir uniquement connu des aveugles", author: "Fujitora", audio: "audios-citations/fujitoraaveugle.mp3", scan: "Épisode 631"},
  {text: "Il y a des batailles qu'on ne gagne pas avec les poings", author: "Marshall D. Teach", audio: "audios-citations/barbenoirepoings.m4a", scan: "Épisode 147"},
  {text: `Quand croyez-vous qu’un homme meurt ?\nQuand il se prend une balle en plein cœur ? Non !\nQuand il est atteint d’une maladie incurable ? Non !\nQuand il a avalé une soupe de champignons vénéneux ? NON !\n… Un homme meurt lorsque son souvenir tombe dans l’oubli !`, author: "Dr Hiluluk", audio: "audios-citations/hilulukmort.m4a", scan: "Épisode 86", hiluluk: true},
  {text: "Le One Piece EXISTE !!!", author: "Edward Newgate", audio: "audios-citations/bbonepiece.mp3", scan: "Épisode 485"},
  {text: "Si nous perdons notre crédibilité en admettant nos erreurs,\nalors nous n'en avions pas en premier lieu", author: "Fujitora", audio: "audios-citations/fujitoracredibilite.m4a", scan: "Épisode 736"},
];

const quoteEl = document.getElementById('quote');
const authorEl = document.getElementById('author');
const scanEl = document.getElementById('scanNumber');
const prevBtn = document.getElementById('prevBtn');
const playPauseBtn = document.getElementById('playPauseBtn');
const audioBtn = document.getElementById('audioBtn');
const nextBtn = document.getElementById('nextBtn');
const quizBtn = document.getElementById('quizBtn');
const searchInput = document.getElementById('searchInput');
const resetSearchBtn = document.querySelector('.reset-search');
const counterEl = document.getElementById('counter');

let currentIndex = 0;
let rotationActive = true;
let rotationTimer = null;
let audioPlaying = false;
let audio = null;
let rotationWasActiveBeforeAudio = false;

let pool = quotes.map((_,i)=>i);
let availablePool = pool.slice();
let poolHistory = [];
let poolHistoryIndex = -1;
let quizMode = false;

function applyFade(el, hide) {
  if(!el) return;
  if(hide) el.style.opacity = 0;
  else el.style.opacity = 1;
}

function stopAudio() { 
  if(audio){ try{audio.pause();}catch{} try{audio.currentTime=0;}catch{} audio=null;} 
  audioPlaying=false; 
}

// --- CORRECTION MINIMALE : retirer la citation du pool quand audio cliqué ---
function renderQuoteByIndex(index){
  // supprime la citation de availablePool si elle y est
  availablePool = availablePool.filter(i => i !== index);

  stopAudio();
  if(pool.length === 0){
    quoteEl.textContent="";
    authorEl.textContent="";
    scanEl.textContent="";
  }

  applyFade(quoteEl,true);
  applyFade(authorEl,true);
  applyFade(scanEl,true);

  setTimeout(()=>{
    currentIndex=index;
    const q=quotes[currentIndex];
    if(q.text.length>200) quoteEl.classList.add('long-quote'); else quoteEl.classList.remove('long-quote');
    if(q.hiluluk) quoteEl.classList.add('hiluluk'); else quoteEl.classList.remove('hiluluk');

    quoteEl.textContent=q.text;
    authorEl.textContent="- "+q.author;
    scanEl.textContent=q.scan||"";

    if(quizMode){
      applyFade(authorEl,true);
      applyFade(scanEl,true);
      quizBtn.classList.add('active'); quizBtn.style.opacity=0.7;
    } else{
      applyFade(authorEl,false);
      applyFade(scanEl,false);
      quizBtn.classList.remove('active'); quizBtn.style.opacity=1;
    }

    applyFade(quoteEl,false);
  },900);
  updateCounter();
}

function updateCounter(){
  const total = quotes.length;
  const filtered = pool.length;
  counterEl.textContent = `${filtered}/${total}`;
}

function updatePoolFromTerm(term){
  const t=(term||"").trim().toLowerCase();
  if(!t){ pool=quotes.map((_,i)=>i); }
  else{
    pool=[];
    quotes.forEach((q,i)=>{ if(q.text.toLowerCase().includes(t)||q.author.toLowerCase().includes(t)||(q.scan && q.scan.toLowerCase().includes(t))) pool.push(i); });
  }
  availablePool=pool.slice();
  poolHistory=[];
  poolHistoryIndex=-1;
  updateCounter();
}

function getNextFromPoolRandom(){
  if(pool.length===0) return -1;
  if(availablePool.length===0) availablePool=pool.slice();
  const r=Math.floor(Math.random()*availablePool.length);
  return availablePool.splice(r,1)[0];
}

function showNextInPool(){
  if(pool.length===0) return;
  if(poolHistoryIndex<poolHistory.length-1){ poolHistoryIndex++; renderQuoteByIndex(poolHistory[poolHistoryIndex]); }
  else { const idx=getNextFromPoolRandom(); poolHistory.push(idx); poolHistoryIndex++; renderQuoteByIndex(idx); }
}

function showPrevInPool(){
  if(poolHistoryIndex>0){ poolHistoryIndex--; renderQuoteByIndex(poolHistory[poolHistoryIndex]); }
}

function startRotation(){ 
  rotationActive=true; 
  playPauseBtn.textContent="❚❚"; 
  clearTimeout(rotationTimer); 
  rotationTimer=setTimeout(()=>{
    showNextInPool(); 
    if(rotationActive) startRotation();
  },10000); 
}

function stopRotation(){ rotationActive=false; playPauseBtn.textContent="▶"; clearTimeout(rotationTimer); }

function toggleRotation(){ rotationActive?stopRotation():startRotation(); }

function toggleAudio(){ 
  if(audioPlaying){ stopAudio(); return; }
  if(!quotes[currentIndex].audio) return;
  rotationWasActiveBeforeAudio=rotationActive; 
  if(rotationActive) stopRotation();
  audio=new Audio(quotes[currentIndex].audio); 
  audioPlaying=true; 
  audio.play().catch(()=>{audioPlaying=false; audio=null;});
  audio.addEventListener('ended',()=>{
    audioPlaying=false; audio=null; 
    if(rotationWasActiveBeforeAudio) startRotation(); else playPauseBtn.textContent="▶"; 
  });
}

prevBtn.addEventListener('click',()=>{ stopRotation(); showPrevInPool(); });
nextBtn.addEventListener('click',()=>{ stopRotation(); showNextInPool(); });
playPauseBtn.addEventListener('click',toggleRotation);
audioBtn.addEventListener('click',toggleAudio);

quizBtn.addEventListener('click',()=>{
  quizMode=!quizMode; 
  if(quizMode){ 
    applyFade(authorEl,true); 
    applyFade(scanEl,true); 
    quizBtn.classList.add('active'); 
    quizBtn.style.opacity=0.7; 
  } else{ 
    applyFade(authorEl,false); 
    applyFade(scanEl,false); 
    quizBtn.classList.remove('active'); 
    quizBtn.style.opacity=1; 
  }
});

searchInput.addEventListener('input',(e)=>{
  const term=e.target.value; 
  updatePoolFromTerm(term); 
  if(rotationActive) stopRotation(); 
  if(pool.length===0){ 
    quoteEl.textContent=""; authorEl.textContent=""; scanEl.textContent=""; 
    return; 
  } 
  const first=pool[0]; 
  availablePool=pool.filter(i=>i!==first); 
  poolHistory=[first]; 
  poolHistoryIndex=0; 
  renderQuoteByIndex(first); 
});

resetSearchBtn.addEventListener('click',()=>{
  searchInput.value=""; 
  updatePoolFromTerm(""); 
  availablePool=pool.slice(); 
  poolHistory=[]; 
  poolHistoryIndex=-1; 
  stopRotation(); 
});

updatePoolFromTerm("");
const firstIdx=getNextFromPoolRandom();
poolHistory.push(firstIdx); poolHistoryIndex=0;
renderQuoteByIndex(firstIdx);
startRotation();
</script>
</body>
</html>
